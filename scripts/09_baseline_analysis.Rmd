---
title: "09_baseline_analysis.Rmd"
author: "Kota Yamamoto"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  message = FALSE,
  warning = FALSE
)

library(tidyverse)
library(arrow)
library(fixest)
library(modelsummary)   

reg_dt <- read_parquet("data/processed/adm2_reg_2019_2024.parquet")

```


# Data Summary

```{r Data Summary, echo=FALSE}
summary(reg_dt)
```

```{r Data detailed summary, echo=FALSE}
datasummary_skim(
reg_dt %>%
select(
ha_alerts, ln_alerts,
loss_ha, ln_loss,
defor_rate,
forest2000_ha,
chirps_mm, chirps_rainy_mm,
cloud_share,
burned_ha
),
type = "numeric"
)
```

# 2. 探索的データ解析（EDA）
```{r ha_alerts, echo=FALSE}
ggplot(reg_dt, aes(x = ha_alerts)) +
geom_histogram(bins = 30) +
labs(x = "ha_alerts", y = "Count")
```

```{r Deforestation rate, echo=FALSE}
ggplot(reg_dt, aes(x = defor_rate)) +
geom_histogram(bins = 30) +
labs(x = "Deforestation rate", y = "Count")
```

```{r Cloud share, echo=FALSE}
ggplot(reg_dt, aes(x = cloud_share, y = ha_alerts)) +
geom_point(alpha = 0.3) +
geom_smooth(method = "lm", se = FALSE) +
labs(x = "Cloud share", y = "ha_alerts")

```

# Baseline OLS
```{r Base OLS, echo=FALSE}
ols_defor <- feols(
defor_rate ~ ln_alerts + chirps_mm + burned_ha |
adm2_code + year,
data    = reg_dt,
cluster = ~adm2_code
)

summary(ols_defor)
```

# IV reg first stage
```{r first stage, echo=FALSE}
fs_ln_alerts <- feols(
ln_alerts ~ cloud_share + chirps_mm + burned_ha |
adm2_code + year,
data    = reg_dt,
cluster = ~adm2_code
)

summary(fs_ln_alerts)
```

# 2SLS second stage
```{r second stage, echo=FALSE}
# 2SLS（ln_alerts を cloud_share で操作）
iv_defor <- feols(
  defor_rate ~ chirps_mm + burned_ha |          # 外生のコントロール
    adm2_code + year |                          # 固定効果
    ln_alerts ~ cloud_share,                    # 内生 ~ IV
  data    = reg_dt,
  cluster = ~adm2_code
)

summary(iv_defor)

```

```{r second stage 2, echo=FALSE}
# 出力先ディレクトリを必ず作成してから書き出す

dir.create("reports/outputs/tables", recursive = TRUE, showWarnings = FALSE)

models_baseline <- list(
"OLS: defor_rate" = ols_defor,
"IV: defor_rate"  = iv_defor
)

modelsummary(
models_baseline,
statistic = "({std.error})",
fmt       = 3,
gof_omit  = "IC|RMSE",
output    = "reports/outputs/tables/baseline.tex"
)
```

# ロバストネスチェック

```{r robustness check, echo=FALSE}
ols_lnloss <- feols(
ln_loss ~ ln_alerts + chirps_mm + burned_ha |
adm2_code + year,
data    = reg_dt,
cluster = ~adm2_code
)

iv_lnloss <- feols(
ln_loss ~ chirps_mm + burned_ha |            # 外生コントロール
adm2_code + year |                         # 固定効果
ln_alerts ~ cloud_share,                   # 内生 ~ IV
data    = reg_dt,
cluster = ~adm2_code
)

models_robust <- list(
"OLS: ln_loss" = ols_lnloss,
"IV: ln_loss"  = iv_lnloss
)

# こちらも同じディレクトリに書き出し

dir.create("reports/outputs/tables", recursive = TRUE, showWarnings = FALSE)

modelsummary(
models_robust,
statistic = "({std.error})",
fmt       = 3,
gof_omit  = "IC|RMSE",
output    = "reports/outputs/tables/robustness.tex"
)

```
